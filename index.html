<!DOCTYPE html>
<html>

<head>
  <title>Sheets Test</title>
  <style>

    * {
      box-sizing: border-box;
    }

    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif
    }

    body {
      display: grid;
      grid-template-rows: min-content 1fr min-content;
    }

    h2 {
      background: black;
      color: white;
      padding: 10px 20px; 
      margin: 0;
    }

    table {
      border: 1px solid black;
      border-right: none;
      border-bottom: none;
    }

    td, th {
        padding: 5px 10px;
        border: 1px solid #000;
        border-top: none;
        border-left: none;
    }

    /* Sticky Header Rows */
    tr:first-child {
      position: sticky;
      top: 0;
      min-height: 30px;
      z-index: 2;
    }

    /* Sticky Columns */

    .sticky {
      position: sticky;
      left: 0;
    }

    .nested {
      position: sticky;
      top: 29px;
    }

    th {
      background: rgb(50, 50, 50);
      color: white;
    }

    th {
      border-right: 1px solid black;
    }

    main {
      overflow: auto;
      width: 100%;
    }

    td {
      background: white;
    }

    td[value="TRUE"], td[value="FALSE"], td[value="true"], td[value="false"] {
      font-size:0;
    }

    td[value="TRUE"]:before, td[value="true"]:before {
      content: "✅";
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    td[value="FALSE"]:before, td[value="false"]:before {
      content: "❌";
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    td[value=""] {
      background: black;
    }
       

    #tabs {
      border-top: 1px solid black;
      width: 100vw;
      display: flex;
      overflow-x: auto;
      padding: 10px;
      background: white;
      gap: 25px;
      font-size: 90%;
    }

    #tabs div {
      cursor: pointer;
    }

    #tabs span {
      font-weight: bold;
    }
  </style>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script lang="javascript" src="https://cdn.jsdelivr.net/npm/xlsx"></script>

</head>

<body>
  <h2></h2>

  <main>
    <table cellpadding="0" cellspacing="0" ></table>
  </main>

  <div id="tabs"></div>

  <script type="module">

    const nColsSticky = 3

    import ecephysRec from './ecephys_recording.json' assert { type: 'json' };
    import ecephysSort from './ecephys_sorting.json' assert { type: 'json' };
    import icephys from './icephys.json' assert { type: 'json' };
    import ophysImg from './ophys_imaging.json' assert { type: 'json' };
    import ophysSeg from './ophys_segmentation.json' assert { type: 'json' };
    import behavior from './behavior.json' assert { type: 'json' };

    const id = '13ikozn6XrOGdWGa_vyxH3MZu4NkN7f4ArHonPLvb9I0'

    const table = document.querySelector('table')
    const stickyTable = document.createElement('table')

    const h2 = document.querySelector('h2')
    const main = document.querySelector('main')

    const tables = {
        'Ecephys - Recording': ecephysRec,
        'Ecephys - Sorting': ecephysSort,
        'Icephys': icephys,
        'Ophys - Imaging': ophysImg,
        'Ophys - Segmentation': ophysSeg,
        'Behavior': behavior
    }

    Object.values(tables).forEach(t => t.columns = t[0] ? Object.keys(t[0]) : [])

    function createCell(value) {
      const td = document.createElement('td')
      if (value === undefined) return
      td.innerHTML = value
      td.setAttribute('value', value)
      return td
    }

    function addColumnsToTable (table, info) {

      let merged = null;
      let headerRowSize = 1
      const nestedRowInfo = []

      // Derive nested headers
      let headers = {}
      info.columns.forEach(str => {
        const lastChar = str.slice(-1)[0]
        // if (lastChar === ' ') {
          merged = null
          headers[str] = true
        //  } else {

        //   const split = str.split(' ')

        //   if (!merged || split.length > 1) {
        //     headerRowSize = 2
        //     merged = split.shift()
        //     headers[merged] = [str]
        //     nestedRowInfo.push(split.join(' '))
        //     return
        //   }

        //   nestedRowInfo.push(str)
        //   headers[merged].push(str)
        // }
      })

      // Add general headers
      const tr = document.createElement('tr')

      const headerEls = Object.entries(headers).map(([cell, info], i) => {
        const th = document.createElement('th')
        const isMerged = info !== true
        if (isMerged) th.setAttribute('colspan',  info.length)
        else th.setAttribute('rowspan',  headerRowSize)
        th.innerText = cell
        return th
      }).flat()

      tr.append(...headerEls)

      table.append(tr)


      // Add nested headers
      if (nestedRowInfo.length) {
          const tr = document.createElement('tr')
          tr.classList.add('nested')
          tr.append(...nestedRowInfo.map(cell => {
            const th = document.createElement('th')
            th.innerText = cell
            return th
          }))
          table.append(tr)
      }

      const rows = info.map(row => {
        const tr = document.createElement('tr')
        tr.append(...Object.entries(headers).map(([header, info]) => {

          if (info === true) return createCell(row[header])
          else return info.map(key => createCell(row[key]))

        }).flat().filter(o => !!o))
        return tr
      })

      const makeSticky = (row) => {
        row.slice(0, nColsSticky).reduce((acc, cell) => {
          cell.classList.add('sticky')
          cell.style.left = `${acc}px`
          return acc + cell.getBoundingClientRect().width
        }, 0)
      }

      table.append(...rows)


      rows.forEach(r => {
        makeSticky(headerEls)
        makeSticky(Array.from(r.children))
      })
    }

    async function updateTable(sheet) {

      table.innerText = ''

      const info = await tables[sheet]

      h2.innerText = sheet

      addColumnsToTable(table, info)

    }

    const tabs = document.getElementById('tabs')
    tabs.append(...Object.keys(tables).map(sheet => {
      const span = document.createElement('span')
      span.innerText = sheet
      const div = document.createElement('div')
      div.onclick = () => updateTable(sheet)
      div.append(span)
      return div
    }))

    updateTable(Object.keys(tables)[0])

  </script>
</body>

</html>