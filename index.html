<!DOCTYPE html>
<html>

<head>
  <title>Sheets Test</title>
  <style>

    * {
      box-sizing: border-box;
    }

    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif
    }

    body {
      display: grid;
      grid-template-rows: 1fr min-content;
    }

    h2 {
      background: black;
      color: white;
      padding: 10px 20px; 
      margin: 0;
    }

    table {
      border: 1px solid black;
      border-right: none;
      border-bottom: none;
      font-size: 14px;
    }

    td, th {
        padding: 5px 10px;
        border: 1px solid #000;
        border-top: none;
        border-left: none;
    }

    tr:first-child {
      position: sticky;
      top: 0;
      min-height: 30px;
      z-index: 2;
    }

    .nested {
      position: sticky;
      top: 27px;
    }

    th {
      background: rgb(50, 50, 50);
      color: white;
      border-right: 1px solid black;
    }

    th > small {
      font-size: 80%;
      font-weight: 400;
    }

    main {
      overflow: auto;
      width: 100%;
    }

    td {
      background: white;
    }

    td small {
      color: rgb(45, 45, 45);
    }

    td[value="TRUE"], td[value="FALSE"], td[value="true"], td[value="false"] {
      font-size:0;
    }

    td[value="TRUE"]:before, td[value="true"]:before {
      content: "✅";
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    td[value="FALSE"]:before, td[value="false"]:before {
      content: "❌";
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    td[value=""] {
      background: black;
    }

    tr > *:first-child {
      position: sticky;
      left: 0;
    }
        

    #tabs {
      border-top: 1px solid black;
      width: 100vw;
      display: flex;
      overflow-x: auto;
      background: white;
      font-size: 90%;
    }

    #tabs div {
      cursor: pointer;
      border: 1px solid #000;
      border-top: none;
      border-left: none;
      padding: 10px 16px;
    }

    #tabs span {
      font-weight: bold;
    }

    #tabs > [selected] {
      color: rgb(8, 86, 255);
      background: rgb(225, 235, 255);
    }

  </style>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script lang="javascript" src="https://cdn.jsdelivr.net/npm/xlsx"></script>

</head>

<body>
  <main>
    <table cellpadding="0" cellspacing="0" ></table>
  </main>

  <div id="tabs"></div>

  <script type="module">

    import ecephysRec from './ecephys_recording.json' assert { type: 'json' };
    import ecephysSort from './ecephys_sorting.json' assert { type: 'json' };
    import icephys from './icephys.json' assert { type: 'json' };
    import ophysImg from './ophys_imaging.json' assert { type: 'json' };
    import ophysSeg from './ophys_segmentation.json' assert { type: 'json' };
    import behavior from './behavior.json' assert { type: 'json' };

    const id = '13ikozn6XrOGdWGa_vyxH3MZu4NkN7f4ArHonPLvb9I0'

    const tabs = document.getElementById('tabs')
    const table = document.querySelector('table')
    const h2 = document.querySelector('h2')

    const tables = {
        'Ecephys - Recording': ecephysRec,
        'Ecephys - Sorting': ecephysSort,
        'Icephys': icephys,
        'Ophys - Imaging': ophysImg,
        'Ophys - Segmentation': ophysSeg,
        'Behavior': behavior
    }

    Object.values(tables).forEach(t => t.columns = t[0] ? Object.keys(t[0]) : [])

    function createCell(value) {
      const td = document.createElement('td')
      if (value === undefined) return

      if (typeof value === 'string') {
        const [title, subtitle] = value.split('-')
        td.innerHTML = `${title}<br><small>${subtitle ?? ""}</small>`
      }

      td.setAttribute('value', value)
      return td
    }

    async function updateTable(sheet) {

      table.innerText = ''

      const info = await tables[sheet]

      Array.from(tabs.children).find(tab => {
        if (tab.innerText === sheet) tab.setAttribute('selected', '')
        else tab.removeAttribute('selected')
      })

      let merged = null;
      let headerRowSize = 1
      const nestedRowInfo = []

      // Derive nested headers
      const headers = {}

      const formatHeader = 'Format'
      const versionsHeader = 'Versions'
      const cols = info.columns
      const formatIdx = cols.findIndex((v) => v === formatHeader)
      const versionsIdx = cols.findIndex((v) => v === versionsHeader)


      // Update format column to include versions as subtitles
      if (formatIdx !== -1 && versionsIdx !== -1) {
        info.forEach(row => {
          if (row[versionsHeader]) row[formatHeader] += ` - ${row[versionsHeader]}`
        })

        cols.splice(versionsIdx, 1)
      }      

      cols.forEach(str => {

        const [ title, subtitle ] = str.split('-')

        const consolidated = headers[title]

        if (subtitle) {
          headerRowSize = 2
          nestedRowInfo.push(subtitle)
          if (consolidated) consolidated.push(str)
          else {
            headers[title] = [ str ]
          }
        } else headers[str] = true
      })


      // Add general headers
      const tr = document.createElement('tr')
      tr.append(...Object.entries(headers).map(([cell, info]) => {
        const th = document.createElement('th')
        const isMerged = info !== true
        if (isMerged) th.setAttribute('colspan',  info.length)
        else th.setAttribute('rowspan',  headerRowSize)
        th.innerText = cell
        return th
      }).flat())

      table.append(tr)


      // Add nested headers
      if (nestedRowInfo.length) {
          const tr = document.createElement('tr')
          tr.classList.add('nested')
          tr.append(...nestedRowInfo.map(cell => {
            const th = document.createElement('th')
            th.innerText = cell
            return th
          }))
          table.append(tr)
      }

      table.append(...info.map(row => {
        const tr = document.createElement('tr')
        tr.append(...Object.entries(headers).map(([header, info]) => {

          if (info === true) return createCell(row[header])
          else return info.map(key => createCell(row[key]))

        }).flat().filter(o => !!o))
        return tr
      }))
    }

    tabs.append(...Object.keys(tables).map(sheet => {
      const span = document.createElement('span')
      span.innerText = sheet
      const div = document.createElement('div')
      div.onclick = () => updateTable(sheet)
      div.append(span)
      return div
    }))

    updateTable(Object.keys(tables)[0])

  </script>
</body>

</html>